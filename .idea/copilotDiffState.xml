<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/src/main/java/org/example/core/report/strategy/ExtentStrategy.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/src/main/java/org/example/core/report/strategy/ExtentStrategy.java" />
              <option name="originalContent" value="package org.example.core.report.strategy;&#10;&#10;import com.aventstack.extentreports.*;&#10;import com.aventstack.extentreports.reporter.ExtentSparkReporter;&#10;import com.aventstack.extentreports.MediaEntityBuilder;&#10;import lombok.extern.slf4j.Slf4j;&#10;import org.example.core.driver.DriverManager;&#10;import org.example.core.report.impl.ExtentTestReporter;&#10;import org.example.enums.BrowserType;&#10;import org.example.configure.Config;&#10;import org.openqa.selenium.*;&#10;import org.openqa.selenium.io.FileHandler;&#10;import org.testng.ITestContext;&#10;import org.testng.ITestResult;&#10;&#10;import java.io.File;&#10;import java.io.IOException;&#10;import java.text.SimpleDateFormat;&#10;import java.util.*;&#10;import java.util.concurrent.ConcurrentHashMap;&#10;&#10;@Slf4j&#10;public class ExtentStrategy implements ReportStrategy {&#10;    private static final ExtentReports EXTENT = new ExtentReports();&#10;    private static final ThreadLocal&lt;ExtentTest&gt; CURRENT_TEST = new ThreadLocal&lt;&gt;();&#10;    private static final Map&lt;String, ExtentTest&gt; NAME_TO_TEST = new ConcurrentHashMap&lt;&gt;();&#10;&#10;    private static volatile boolean INITIALIZED = false;&#10;    private static String REPORT_DIR = null;&#10;&#10;    @Override&#10;    public void onStart(ITestContext context) {&#10;        if (INITIALIZED) return;&#10;        synchronized (ExtentStrategy.class) {&#10;            if (INITIALIZED) return;&#10;&#10;            // Tạo thư mục chứa report và screenshot&#10;            String timestamp = new SimpleDateFormat(&quot;yyyyMMdd_HHmmss&quot;).format(new Date());&#10;            REPORT_DIR = &quot;target/extent-report/&quot; + timestamp;&#10;            File reportDir = new File(REPORT_DIR);&#10;            if (!reportDir.exists()) reportDir.mkdirs();&#10;&#10;            File htmlReport = new File(REPORT_DIR, &quot;index.html&quot;);&#10;            ExtentSparkReporter spark = new ExtentSparkReporter(htmlReport);&#10;&#10;            try {&#10;                String suiteName = (context != null &amp;&amp; context.getSuite() != null)&#10;                        ? context.getSuite().getName()&#10;                        : &quot;Automation Test Suite&quot;;&#10;&#10;                spark.config().setDocumentTitle(suiteName);&#10;                spark.config().setReportName(suiteName);&#10;                spark.config().setEncoding(&quot;utf-8&quot;);&#10;&#10;                EXTENT.attachReporter(spark);&#10;                EXTENT.setSystemInfo(&quot;Suite&quot;, suiteName);&#10;                EXTENT.setSystemInfo(&quot;Environment&quot;, Config.getEnvFile());&#10;                EXTENT.setSystemInfo(&quot;Browser&quot;, Config.getBrowserType().name());&#10;                log.info(&quot;✅ ExtentReports initialized at {}&quot;, htmlReport.getAbsolutePath());&#10;            } catch (Throwable t) {&#10;                log.warn(&quot;⚠️ Failed to initialize ExtentSparkReporter: {}&quot;, t.getMessage(), t);&#10;            } finally {&#10;                INITIALIZED = true;&#10;            }&#10;        }&#10;    }&#10;&#10;    @Override&#10;    public void onFinish(ITestContext context) {&#10;        try {&#10;            EXTENT.flush();&#10;            log.info(&quot;✅ Extent report generated at {}&quot;, REPORT_DIR);&#10;        } catch (Throwable t) {&#10;            log.warn(&quot;Extent flush failed: {}&quot;, t.getMessage());&#10;        }&#10;        ExtentTestReporter.clearTest();&#10;    }&#10;&#10;    @Override&#10;    public void onTestStart(ITestResult result) {&#10;        String testName = result.getMethod().getMethodName();&#10;        ExtentTest test = EXTENT.createTest(testName);&#10;        NAME_TO_TEST.put(testName, test);&#10;        CURRENT_TEST.set(test);&#10;        ExtentTestReporter.setTest(test);&#10;    }&#10;&#10;    @Override&#10;    public void onTestSuccess(ITestResult result) {&#10;        getTest(result).ifPresent(t -&gt; t.log(Status.PASS, &quot;✅ Test Passed&quot;));&#10;    }&#10;&#10;    @Override&#10;    public void onTestFailure(ITestResult result) {&#10;        if (isSoftAssertHandled(result)) return;&#10;&#10;        Throwable error = result.getThrowable();&#10;        String message = (error == null) ? &quot;❌ Test Failed&quot; : error.getMessage();&#10;        String screenshot = attachScreenshot();&#10;&#10;        getTest(result).ifPresent(t -&gt; {&#10;            try {&#10;                if (screenshot != null)&#10;                    t.fail(message, MediaEntityBuilder.createScreenCaptureFromPath(screenshot).build());&#10;                else&#10;                    t.fail(message);&#10;            } catch (Exception e) {&#10;                t.log(Status.FAIL, message);&#10;            }&#10;        });&#10;    }&#10;&#10;    @Override&#10;    public void onTestSkipped(ITestResult result) {&#10;        String screenshot = attachScreenshot();&#10;        getTest(result).ifPresent(t -&gt; {&#10;            try {&#10;                if (screenshot != null)&#10;                    t.skip(&quot;⏭️ Skipped&quot;, MediaEntityBuilder.createScreenCaptureFromPath(screenshot).build());&#10;                else&#10;                    t.skip(&quot;⏭️ Skipped&quot;);&#10;            } catch (Exception e) {&#10;                t.log(Status.SKIP, &quot;Skipped&quot;);&#10;            }&#10;        });&#10;    }&#10;&#10;    @Override public void onTestFailedButWithinSuccessPercentage(ITestResult result) {}&#10;    @Override public void onTestFailedWithTimeout(ITestResult result) { onTestFailure(result); }&#10;&#10;    @Override&#10;    public void onConfigurationSuccess(ITestResult itr) {&#10;        ExtentTest test = getLastTestFromContext(itr);&#10;        if (test != null) {&#10;            CURRENT_TEST.set(test);&#10;            ExtentTestReporter.setTest(test);&#10;            log.debug(&quot;Restored context for @Configuration method: {}&quot;, itr.getMethod().getMethodName());&#10;        }&#10;    }&#10;&#10;    @Override&#10;    public void onConfigurationFailure(ITestResult itr) {&#10;        Throwable t = itr.getThrowable();&#10;        String message = (t == null) ? &quot;⚙️ Config failed&quot; : &quot;⚙️ Config failed: &quot; + t.getMessage();&#10;        String screenshot = attachScreenshot();&#10;&#10;        getTest(itr).ifPresent(test -&gt; {&#10;            try {&#10;                if (screenshot != null)&#10;                    test.fail(message, MediaEntityBuilder.createScreenCaptureFromPath(screenshot).build());&#10;                else&#10;                    test.log(Status.FAIL, message);&#10;            } catch (Exception e) {&#10;                test.log(Status.FAIL, message);&#10;            }&#10;        });&#10;    }&#10;&#10;    @Override public void onConfigurationSkip(ITestResult itr) {}&#10;&#10;    @Override&#10;    public void failStep(String stepName) {&#10;        try {&#10;            ExtentTest test = CURRENT_TEST.get();&#10;            if (test == null) test = EXTENT.createTest(stepName);&#10;&#10;            String screenshot = attachScreenshot();&#10;            if (screenshot != null)&#10;                test.fail(stepName, MediaEntityBuilder.createScreenCaptureFromPath(screenshot).build());&#10;            else&#10;                test.fail(stepName);&#10;        } catch (Throwable t) {&#10;            log.warn(&quot;failStep failed: {}&quot;, t.getMessage());&#10;        }&#10;    }&#10;&#10;    // ================== Screenshot logic ==================&#10;    private String attachScreenshot() {&#10;        try {&#10;            BrowserType browserType = Config.getBrowserType();&#10;            WebDriver driver = DriverManager.getInstance(browserType).getDriver();&#10;            if (driver != null &amp;&amp; driver instanceof TakesScreenshot) {&#10;                String screenshotName = &quot;screenshot_&quot; + System.currentTimeMillis() + &quot;.png&quot;;&#10;                File src = ((TakesScreenshot) driver).getScreenshotAs(OutputType.FILE);&#10;&#10;                File screenshotDir = new File(REPORT_DIR, &quot;screenshots&quot;);&#10;                if (!screenshotDir.exists()) screenshotDir.mkdirs();&#10;&#10;                File dest = new File(screenshotDir, screenshotName);&#10;                FileHandler.copy(src, dest);&#10;&#10;                // Trả về đường dẫn tương đối để hiển thị được trong HTML&#10;                return &quot;screenshots/&quot; + screenshotName;&#10;            }&#10;        } catch (Throwable e) {&#10;            log.warn(&quot;❌ Screenshot capture failed: {}&quot;, e.getMessage());&#10;        }&#10;        return null;&#10;    }&#10;&#10;    // ================== Helpers ==================&#10;    private Optional&lt;ExtentTest&gt; getTest(ITestResult result) {&#10;        ExtentTest test = CURRENT_TEST.get();&#10;        if (test != null) return Optional.of(test);&#10;        return Optional.ofNullable(NAME_TO_TEST.get(result.getMethod().getMethodName()));&#10;    }&#10;&#10;    private ExtentTest getLastTestFromContext(ITestResult itr) {&#10;        try {&#10;            var ctx = itr.getTestContext();&#10;            List&lt;ITestResult&gt; all = new ArrayList&lt;&gt;();&#10;            all.addAll(ctx.getPassedTests().getAllResults());&#10;            all.addAll(ctx.getFailedTests().getAllResults());&#10;            all.addAll(ctx.getSkippedTests().getAllResults());&#10;            if (all.isEmpty()) return null;&#10;&#10;            all.sort(Comparator.comparingLong(ITestResult::getEndMillis).reversed());&#10;            String lastTestName = all.get(0).getMethod().getMethodName();&#10;            return NAME_TO_TEST.get(lastTestName);&#10;        } catch (Throwable t) {&#10;            return null;&#10;        }&#10;    }&#10;&#10;    private boolean isSoftAssertHandled(ITestResult result) {&#10;        try {&#10;            if (org.example.core.report.FailureTracker.isHandledForCurrentThread()&#10;                    || Boolean.TRUE.equals(result.getAttribute(&quot;soft.assert.handled&quot;))) {&#10;                org.example.core.report.FailureTracker.clearForCurrentThread();&#10;                return true;&#10;            }&#10;        } catch (Throwable ignored) {}&#10;        return false;&#10;    }&#10;}&#10;" />
              <option name="updatedContent" value="package org.example.core.report.strategy;&#10;&#10;import com.aventstack.extentreports.*;&#10;import com.aventstack.extentreports.reporter.ExtentSparkReporter;&#10;import com.aventstack.extentreports.MediaEntityBuilder;&#10;import lombok.extern.slf4j.Slf4j;&#10;import org.example.core.driver.DriverManager;&#10;import org.example.core.report.impl.ExtentTestReporter;&#10;import org.example.enums.BrowserType;&#10;import org.example.configure.Config;&#10;import org.openqa.selenium.*;&#10;import org.openqa.selenium.io.FileHandler;&#10;import org.testng.ITestContext;&#10;import org.testng.ITestResult;&#10;&#10;import java.io.File;&#10;import java.io.IOException;&#10;import java.text.SimpleDateFormat;&#10;import java.util.*;&#10;import java.util.concurrent.ConcurrentHashMap;&#10;&#10;@Slf4j&#10;public class ExtentStrategy implements ReportStrategy {&#10;    private static final ExtentReports EXTENT = new ExtentReports();&#10;    private static final ThreadLocal&lt;ExtentTest&gt; CURRENT_TEST = new ThreadLocal&lt;&gt;();&#10;    private static final Map&lt;String, ExtentTest&gt; NAME_TO_TEST = new ConcurrentHashMap&lt;&gt;();&#10;&#10;    private static volatile boolean INITIALIZED = false;&#10;    private static String REPORT_DIR = null;&#10;&#10;    @Override&#10;    public void onStart(ITestContext context) {&#10;        if (INITIALIZED) return;&#10;        synchronized (ExtentStrategy.class) {&#10;            if (INITIALIZED) return;&#10;&#10;            // Tạo thư mục chứa report và screenshot&#10;            String timestamp = new SimpleDateFormat(&quot;yyyyMMdd_HHmmss&quot;).format(new Date());&#10;            REPORT_DIR = &quot;target/extent-report/&quot; + timestamp;&#10;            File reportDir = new File(REPORT_DIR);&#10;            if (!reportDir.exists()) reportDir.mkdirs();&#10;&#10;            // Use timestamp in the HTML report filename so each run has a unique report file&#10;            File htmlReport = new File(REPORT_DIR, &quot;index_&quot; + timestamp + &quot;.html&quot;);&#10;            ExtentSparkReporter spark = new ExtentSparkReporter(htmlReport);&#10;&#10;            try {&#10;                String suiteName = (context != null &amp;&amp; context.getSuite() != null)&#10;                        ? context.getSuite().getName()&#10;                        : &quot;Automation Test Suite&quot;;&#10;&#10;                spark.config().setDocumentTitle(suiteName);&#10;                spark.config().setReportName(suiteName);&#10;                spark.config().setEncoding(&quot;utf-8&quot;);&#10;&#10;                EXTENT.attachReporter(spark);&#10;                EXTENT.setSystemInfo(&quot;Suite&quot;, suiteName);&#10;                EXTENT.setSystemInfo(&quot;Environment&quot;, Config.getEnvFile());&#10;                EXTENT.setSystemInfo(&quot;Browser&quot;, Config.getBrowserType().name());&#10;                log.info(&quot;✅ ExtentReports initialized at {}&quot;, htmlReport.getAbsolutePath());&#10;            } catch (Throwable t) {&#10;                log.warn(&quot;⚠️ Failed to initialize ExtentSparkReporter: {}&quot;, t.getMessage(), t);&#10;            } finally {&#10;                INITIALIZED = true;&#10;            }&#10;        }&#10;    }&#10;&#10;    @Override&#10;    public void onFinish(ITestContext context) {&#10;        try {&#10;            EXTENT.flush();&#10;            log.info(&quot;✅ Extent report generated at {}&quot;, REPORT_DIR);&#10;        } catch (Throwable t) {&#10;            log.warn(&quot;Extent flush failed: {}&quot;, t.getMessage());&#10;        }&#10;        ExtentTestReporter.clearTest();&#10;    }&#10;&#10;    @Override&#10;    public void onTestStart(ITestResult result) {&#10;        String testName = result.getMethod().getMethodName();&#10;        ExtentTest test = EXTENT.createTest(testName);&#10;        NAME_TO_TEST.put(testName, test);&#10;        CURRENT_TEST.set(test);&#10;        ExtentTestReporter.setTest(test);&#10;    }&#10;&#10;    @Override&#10;    public void onTestSuccess(ITestResult result) {&#10;        getTest(result).ifPresent(t -&gt; t.log(Status.PASS, &quot;✅ Test Passed&quot;));&#10;    }&#10;&#10;    @Override&#10;    public void onTestFailure(ITestResult result) {&#10;        if (isSoftAssertHandled(result)) return;&#10;&#10;        Throwable error = result.getThrowable();&#10;        String message = (error == null) ? &quot;❌ Test Failed&quot; : error.getMessage();&#10;        String screenshot = attachScreenshot();&#10;&#10;        getTest(result).ifPresent(t -&gt; {&#10;            try {&#10;                if (screenshot != null)&#10;                    t.fail(message, MediaEntityBuilder.createScreenCaptureFromPath(screenshot).build());&#10;                else&#10;                    t.fail(message);&#10;            } catch (Exception e) {&#10;                t.log(Status.FAIL, message);&#10;            }&#10;        });&#10;    }&#10;&#10;    @Override&#10;    public void onTestSkipped(ITestResult result) {&#10;        String screenshot = attachScreenshot();&#10;        getTest(result).ifPresent(t -&gt; {&#10;            try {&#10;                if (screenshot != null)&#10;                    t.skip(&quot;⏭️ Skipped&quot;, MediaEntityBuilder.createScreenCaptureFromPath(screenshot).build());&#10;                else&#10;                    t.skip(&quot;⏭️ Skipped&quot;);&#10;            } catch (Exception e) {&#10;                t.log(Status.SKIP, &quot;Skipped&quot;);&#10;            }&#10;        });&#10;    }&#10;&#10;    @Override public void onTestFailedButWithinSuccessPercentage(ITestResult result) {}&#10;    @Override public void onTestFailedWithTimeout(ITestResult result) { onTestFailure(result); }&#10;&#10;    @Override&#10;    public void onConfigurationSuccess(ITestResult itr) {&#10;        ExtentTest test = getLastTestFromContext(itr);&#10;        if (test != null) {&#10;            CURRENT_TEST.set(test);&#10;            ExtentTestReporter.setTest(test);&#10;            log.debug(&quot;Restored context for @Configuration method: {}&quot;, itr.getMethod().getMethodName());&#10;        }&#10;    }&#10;&#10;    @Override&#10;    public void onConfigurationFailure(ITestResult itr) {&#10;        Throwable t = itr.getThrowable();&#10;        String message = (t == null) ? &quot;⚙️ Config failed&quot; : &quot;⚙️ Config failed: &quot; + t.getMessage();&#10;        String screenshot = attachScreenshot();&#10;&#10;        getTest(itr).ifPresent(test -&gt; {&#10;            try {&#10;                if (screenshot != null)&#10;                    test.fail(message, MediaEntityBuilder.createScreenCaptureFromPath(screenshot).build());&#10;                else&#10;                    test.log(Status.FAIL, message);&#10;            } catch (Exception e) {&#10;                test.log(Status.FAIL, message);&#10;            }&#10;        });&#10;    }&#10;&#10;    @Override public void onConfigurationSkip(ITestResult itr) {}&#10;&#10;    @Override&#10;    public void failStep(String stepName) {&#10;        try {&#10;            ExtentTest test = CURRENT_TEST.get();&#10;            if (test == null) test = EXTENT.createTest(stepName);&#10;&#10;            String screenshot = attachScreenshot();&#10;            if (screenshot != null)&#10;                test.fail(stepName, MediaEntityBuilder.createScreenCaptureFromPath(screenshot).build());&#10;            else&#10;                test.fail(stepName);&#10;        } catch (Throwable t) {&#10;            log.warn(&quot;failStep failed: {}&quot;, t.getMessage());&#10;        }&#10;    }&#10;&#10;    // ================== Screenshot logic ==================&#10;    private String attachScreenshot() {&#10;        try {&#10;            BrowserType browserType = Config.getBrowserType();&#10;            WebDriver driver = DriverManager.getInstance(browserType).getDriver();&#10;            if (driver != null &amp;&amp; driver instanceof TakesScreenshot) {&#10;                String screenshotName = &quot;screenshot_&quot; + System.currentTimeMillis() + &quot;.png&quot;;&#10;                File src = ((TakesScreenshot) driver).getScreenshotAs(OutputType.FILE);&#10;&#10;                File screenshotDir = new File(REPORT_DIR, &quot;screenshots&quot;);&#10;                if (!screenshotDir.exists()) screenshotDir.mkdirs();&#10;&#10;                File dest = new File(screenshotDir, screenshotName);&#10;                FileHandler.copy(src, dest);&#10;&#10;                // Trả về đường dẫn tương đối để hiển thị được trong HTML&#10;                return &quot;screenshots/&quot; + screenshotName;&#10;            }&#10;        } catch (Throwable e) {&#10;            log.warn(&quot;❌ Screenshot capture failed: {}&quot;, e.getMessage());&#10;        }&#10;        return null;&#10;    }&#10;&#10;    // ================== Helpers ==================&#10;    private Optional&lt;ExtentTest&gt; getTest(ITestResult result) {&#10;        ExtentTest test = CURRENT_TEST.get();&#10;        if (test != null) return Optional.of(test);&#10;        return Optional.ofNullable(NAME_TO_TEST.get(result.getMethod().getMethodName()));&#10;    }&#10;&#10;    private ExtentTest getLastTestFromContext(ITestResult itr) {&#10;        try {&#10;            var ctx = itr.getTestContext();&#10;            List&lt;ITestResult&gt; all = new ArrayList&lt;&gt;();&#10;            all.addAll(ctx.getPassedTests().getAllResults());&#10;            all.addAll(ctx.getFailedTests().getAllResults());&#10;            all.addAll(ctx.getSkippedTests().getAllResults());&#10;            if (all.isEmpty()) return null;&#10;&#10;            all.sort(Comparator.comparingLong(ITestResult::getEndMillis).reversed());&#10;            String lastTestName = all.get(0).getMethod().getMethodName();&#10;            return NAME_TO_TEST.get(lastTestName);&#10;        } catch (Throwable t) {&#10;            return null;&#10;        }&#10;    }&#10;&#10;    private boolean isSoftAssertHandled(ITestResult result) {&#10;        try {&#10;            if (org.example.core.report.FailureTracker.isHandledForCurrentThread()&#10;                    || Boolean.TRUE.equals(result.getAttribute(&quot;soft.assert.handled&quot;))) {&#10;                org.example.core.report.FailureTracker.clearForCurrentThread();&#10;                return true;&#10;            }&#10;        } catch (Throwable ignored) {}&#10;        return false;&#10;    }&#10;}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>